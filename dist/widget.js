var AIFurnitureWidget=function(e){"use strict";const t="undefined"!=typeof window?new URLSearchParams(window.location.search):null,n="undefined"!=typeof window&&("localhost"===window.location.hostname||"127.0.0.1"===window.location.hostname||"0.0.0.0"===window.location.hostname),o="true"===t?.get("aif_local")||n,i={apiEndpoint:o?"http://localhost:3000/api":"https://ai-furniture-backend.vercel.app/api",trackingEndpoint:o?"http://localhost:3000/api/tracking/pixel":"https://ai-furniture-backend.vercel.app/api/tracking/pixel",widgetEndpoint:o?"http://localhost:3000/furniture":"https://ai-furniture-backend.vercel.app/furniture",debug:o};const a="ai_furniture_widget_state",r="ai_furniture_modal_state",s=e=>new Promise((t,n)=>{const o=new FileReader;o.onload=()=>t(o.result),o.onerror=n,o.readAsDataURL(e)}),l={UPLOAD:"UPLOAD",GENERATING:"GENERATING",RESULTS:"RESULTS",ERROR:"ERROR",QUEUE:"QUEUE"},d="PENDING",c="PROCESSING",u="COMPLETED",p="ERROR",g=(e=>{const t=(()=>{try{const e=sessionStorage.getItem(a);return e?JSON.parse(e):void 0}catch(e){return void console.warn("Failed to load state",e)}})(),n=(()=>{try{const e=sessionStorage.getItem(r);return e?JSON.parse(e):{isOpen:!1,view:l.UPLOAD}}catch(e){return{isOpen:!1,view:l.UPLOAD}}})();let o=[];t&&t.queue&&(o=t.queue.map(e=>{const t={...e};return e.userImageDataUrl&&(t.userImage=(e=>{if(!e)return null;try{const t=e.split(","),n=t[0].match(/:(.*?);/)[1],o=atob(t[1]);let i=o.length;const a=new Uint8Array(i);for(;i--;)a[i]=o.charCodeAt(i);return new Blob([a],{type:n})}catch(e){return console.warn("Failed to convert data URL to blob",e),null}})(e.userImageDataUrl)),t}));let i={...e,...t,queue:o.length>0?o:t?.queue||e.queue,...n};const d=new Set;return{getState:()=>i,setState:e=>{i={...i,...e},(async e=>{try{const{queue:t,generatedImages:n,selectedModel:o,queueTab:i}=e,r=await Promise.all(t.map(async e=>{const t={...e};if(e.userImage&&(e.userImage instanceof File||e.userImage instanceof Blob)&&!e.userImageDataUrl)try{t.userImageDataUrl=await s(e.userImage)}catch(e){console.warn("Failed to convert image to data URL",e)}return delete t.userImage,t}));sessionStorage.setItem(a,JSON.stringify({queue:r,generatedImages:n,selectedModel:o,queueTab:i}))}catch(e){console.warn("Failed to save state",e)}})(i).catch(e=>console.warn("Failed to save state",e)),("isOpen"in e||"view"in e)&&((e,t)=>{try{sessionStorage.setItem(r,JSON.stringify({isOpen:e,view:t}))}catch(e){console.warn("Failed to save modal state",e)}})(i.isOpen,i.view),d.forEach(e=>e(i))},subscribe:e=>(d.add(e),()=>d.delete(e))}})({isOpen:!1,view:l.UPLOAD,uploadedImage:null,generatedImages:[],queue:[],error:null,sessionId:null,config:{},isMobile:"undefined"!=typeof window&&window.innerWidth<=768,selectedModel:"slow",queueTab:"all"}),m={openModal:(e={})=>{const t={...g.getState().config,...e};if(!t.apiEndpoint){const e="undefined"!=typeof window&&("localhost"===window.location.hostname||"127.0.0.1"===window.location.hostname||"0.0.0.0"===window.location.hostname);t.apiEndpoint=e?"http://localhost:3000/api":"https://ai-furniture-backend.vercel.app/api"}g.setState({isOpen:!0,config:t})},closeModal:()=>{g.setState({isOpen:!1})},setUploadedImage:e=>{g.setState({uploadedImage:e,view:l.UPLOAD})},startGeneration:()=>{g.setState({view:l.GENERATING,error:null})},setGenerationResults:e=>{g.setState({generatedImages:e,view:l.RESULTS})},setError:e=>{g.setState({error:e,view:l.ERROR})},reset:()=>{g.setState({view:l.UPLOAD,uploadedImage:null,generatedImages:[],error:null})},updateDimensions:()=>{g.setState({isMobile:window.innerWidth<=768})},addToQueue:e=>{const t=g.getState().queue,n={...e,status:d,timestamp:Date.now()};e.userImage&&(e.userImage instanceof File||e.userImage instanceof Blob)&&s(e.userImage).then(e=>{n.userImageDataUrl=e;const t=g.getState().queue.map(t=>t.id===n.id?{...t,userImageDataUrl:e}:t);g.setState({queue:t})}).catch(e=>{console.warn("Failed to convert image to data URL for queue item",e)}),g.setState({queue:[...t,n]})},updateQueueItem:(e,t)=>{const n=g.getState().queue.map(n=>n.id===e?{...n,...t}:n);g.setState({queue:n})},removeFromQueue:e=>{const t=g.getState().queue.filter(t=>t.id!==e);g.setState({queue:t})},setView:e=>{g.setState({view:e})},setSelectedModel:e=>{g.setState({selectedModel:e})},setQueueTab:e=>{g.setState({queueTab:e})},clearCompleted:()=>{const e=g.getState().queue.filter(e=>e.status!==u);g.setState({queue:e})}},f=({text:e,onClick:t,disabled:n=!1,loading:o=!1,variant:i="primary",className:a=""})=>{const r=document.createElement("button");if(r.className=`aif-btn-${i} ${a}`,r.disabled=n||o,o){const t=document.createElement("div");t.className="aif-spinner",r.appendChild(t);const n=document.createElement("span");n.textContent=" "+e,r.appendChild(n),r.style.display="flex",r.style.alignItems="center",r.style.justifyContent="center",r.style.gap="8px"}else r.textContent=e;return r.addEventListener("click",t),r};let h=null,y=null;function b(e){h=e,g.setState({config:e})}function w(){if(!h)throw new Error("AI Furniture: config not set. Call initAIFurnitureWidget first.");return h}function x(e){y=e}function v(){return y}function I(e,t){w().debug&&console.log("[AI Furniture Widget]",e,t||"")}function E(){const e=window.location.href.toLowerCase(),t=document.title.toLowerCase(),n=document.body.textContent.toLowerCase(),o=document.querySelector("[data-product-id]")||document.querySelector(".product")||document.querySelector("#product")||document.querySelector('[class*="product"]')||document.querySelector('[id*="product"]'),i=document.querySelector('[class*="price"]')||document.querySelector('[id*="price"]')||/\$[\d,]+/.test(n)||/¬£[\d,]+/.test(n)||/‚Ç¨[\d,]+/.test(n),a=["sofa","couch","chair","table","bed","desk","cabinet","shelf","dresser","nightstand","wardrobe","ottoman","bench","stool","armchair","dining","bedroom","living","furniture","product"].some(o=>e.includes(o)||t.includes(o)||n.includes(o));return o&&i&&a}function k(){const e="true"===sessionStorage.getItem("ai_furniture_user");if(!e)return console.log("‚ùå Skipping cart/order page detection - user has not used AI Furniture"),I("Skipping cart/order page detection - user has not used AI Furniture"),{isCartPage:!1,isOrderPage:!1,pageType:"product"};const t=window.location.href.toLowerCase(),n=window.location.pathname.toLowerCase(),o=document.title.toLowerCase(),i=document.body.textContent.toLowerCase(),a=[/\/cart/,/\/basket/,/\/shopping-cart/,/\/checkout\/cart/,/\/cart\.html/,/\/basket\.html/,/\/shopping-cart\.html/,/[?&]cart/,/[?&]basket/,/[?&]add-to-cart/,/cart/,/basket/,/shopping cart/,/your cart/,/shopping bag/,/cart total/,/basket total/,/shopping cart/,/proceed to checkout/,/update cart/,/remove from cart/,/empty cart/,/cart is empty/].some(e=>e.test(t)||e.test(n)||e.test(o)||e.test(i)),r=[/\/checkout/,/\/order/,/\/payment/,/\/billing/,/\/shipping/,/\/review/,/\/confirm/,/\/success/,/\/thank-you/,/\/order-confirmation/,/\/checkout\/success/,/\/order\/success/,/\/payment\/success/,/\/checkout\.html/,/\/order\.html/,/\/payment\.html/,/\/success\.html/,/\/thank-you\.html/,/[?&]checkout/,/[?&]order/,/[?&]payment/,/[?&]success/,/[?&]order_id/,/[?&]transaction_id/,/checkout/,/order/,/payment/,/billing/,/shipping/,/review order/,/order confirmation/,/payment confirmation/,/thank you/,/order successful/,/payment successful/,/billing information/,/shipping information/,/payment method/,/order summary/,/total amount/,/place order/,/complete purchase/,/order confirmed/,/payment successful/,/thank you for your order/,/order number/,/confirmation number/,/transaction id/].some(e=>e.test(t)||e.test(n)||e.test(o)||e.test(i));let s="product";if(a?s="cart":r&&(s="order"),a||r){const n={pageType:s,url:window.location.href,title:document.title,detectedBy:"generalized_detection"},o=sessionStorage.getItem("ai_furniture_session_id");n.aiFurnitureUser=!0,n.aiFurnitureSessionId=o,n.eventType=`ai_furniture_user_${s}_page_visit`,A(`${s}_page_visit`,n),I(`${s} page detected:`,{url:window.location.href,title:document.title,pageType:s,aiFurnitureUser:e}),r&&(t.includes("success")||t.includes("thank")||t.includes("confirmation")||t.includes("complete"))&&I("Order confirmation page detected - continuing to track until order confirmed in database")}return{isCartPage:a,isOrderPage:r,pageType:s}}let S=null;function C(){return"session_"+Date.now()+"_"+Math.random().toString(36).substr(2,9)}function A(e,t={}){const n=w(),o=v();console.log("üì° TRACK EVENT CALLED:",{eventType:e,currentUrl:window.location.href,currentPage:window.location.pathname+window.location.search});const i="true"===sessionStorage.getItem("tracking_disconnected");if(console.log("üîç TRACKING STATUS CHECK:",{trackingDisconnected:i,eventType:e,willSendEvent:!i}),i)return console.log("‚ùå Tracking already disconnected - skipping event:",e),void I("Skipping tracking - session has timed out and tracking disconnected");const a=new URLSearchParams({sessionId:o,domain:n.domain,eventType:e,page:window.location.pathname+window.location.search,timestamp:(new Date).toISOString(),userAgent:navigator.userAgent,referrer:document.referrer,title:document.title,url:window.location.href});for(const[e,n]of Object.entries(t))null!=n&&a.append(`data_${e}`,"object"==typeof n?JSON.stringify(n):String(n));let r=n.apiEndpoint;if(!r){r="undefined"!=typeof window&&("localhost"===window.location.hostname||"127.0.0.1"===window.location.hostname||"0.0.0.0"===window.location.hostname)?"http://localhost:3000/api":"https://ai-furniture-backend.vercel.app/api",console.warn("‚ö†Ô∏è apiEndpoint was undefined in tracking, using fallback:",r)}if(!r||"string"!=typeof r)return void console.error("‚ùå Invalid API endpoint, cannot send tracking event");const s=`${r}?${a.toString()}`;console.log("üì§ SENDING PIXEL REQUEST TO BACKEND:",{url:s,eventType:e,paramsCount:a.toString().split("&").length}),I("Pixel tracking URL",s);const l=new Image;l.onload=function(){I("Pixel loaded successfully",{eventType:e}),console.log("Pixel tracking successful:",e)},l.onerror=function(){I("Pixel failed to load",{eventType:e}),console.error("Pixel tracking failed:",e)},l.src=s}function R(){console.log("üîå DISCONNECTING ALL TRACKING - ORDER COMPLETED!"),I("Disconnecting all tracking - order completed"),sessionStorage.setItem("tracking_disconnected","true"),sessionStorage.setItem("order_completed_at",(new Date).toISOString()),sessionStorage.setItem("order_completion_reason","order_placed"),console.log("‚úÖ Tracking marked as disconnected in sessionStorage"),setTimeout(()=>{T()},2e3)}function T(){console.log("üîÑ RESETTING WIDGET - CLEARING ALL TRACKING STATE!"),I("Resetting widget - clearing all tracking state"),sessionStorage.removeItem("ai_furniture_user"),sessionStorage.removeItem("ai_furniture_session_id"),sessionStorage.removeItem("aifurniture_session_id"),sessionStorage.removeItem("tracking_disconnected"),sessionStorage.removeItem("order_completed_at"),sessionStorage.removeItem("order_completion_reason"),sessionStorage.removeItem("session_ended_at"),sessionStorage.removeItem("ai_furniture_original_url");const e=document.querySelector("#ai-furniture-widget");e&&(e.remove(),console.log("üóëÔ∏è Removed existing widget button"));const t=C();sessionStorage.setItem("ai_furniture_session_id",t),x(t),I("Widget reset complete - user can now use AI Furniture widget again",{newSessionId:t}),function(){const e=document.createElement("div");e.innerHTML="\n      <div style=\"\n        position: fixed;\n        top: 20px;\n        right: 20px;\n        background: linear-gradient(135deg, #10b981, #059669);\n        color: white;\n        padding: 12px 20px;\n        border-radius: 12px;\n        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n        font-size: 14px;\n        font-weight: 600;\n        z-index: 10000;\n        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);\n        animation: slideIn 0.3s ease-out;\n      \">\n        ‚úÖ Order completed! AI Furniture widget refreshed for new session\n      </div>\n      <style>\n        @keyframes slideIn {\n          from { transform: translateX(100%); opacity: 0; }\n          to { transform: translateX(0); opacity: 1; }\n        }\n      </style>\n    ",document.body.appendChild(e),setTimeout(()=>{e.parentNode&&e.parentNode.removeChild(e)},4e3)}(),"function"==typeof S&&E()&&setTimeout(()=>{S(),console.log("üîÑ Widget button recreated for new session")},1e3)}function _(e){console.log("üéâ ORDER CONFIRMED IN DATABASE - disconnecting tracking immediately",e),I("Order successfully added to database - disconnecting tracking immediately",e),R()}const D=e=>{const t=document.createElement("div");t.style.display="flex",t.style.flexDirection="column",t.style.gap="16px",t.style.height="100%";const n=document.createElement("div");n.className="aif-header",n.innerHTML='\n    <div class="aif-badge">\n      <span style="width:6px; height:6px; border-radius:50%; background:#22c55e;"></span>\n      Room Visualiser\n    </div>\n    <h2>See this in your own room</h2>\n    <p>Upload a photo of your room. We\'ll swap your current furniture for this one, matching the angle and lighting.</p>\n  ',t.appendChild(n);const o=e.queue.length;if(o>0){const n=document.createElement("div");n.style.padding="12px",n.style.background="#eff6ff",n.style.border="1px solid #3b82f6",n.style.borderRadius="8px",n.style.display="flex",n.style.alignItems="center",n.style.justifyContent="space-between",n.style.cursor="pointer",n.onclick=()=>m.setView("QUEUE");const i=e.queue.filter(e=>"COMPLETED"===e.status).length,a=e.queue.filter(e=>"PROCESSING"===e.status).length;let r=`${o} item${o>1?"s":""} in queue`;i>0&&(r+=` ‚Ä¢ ${i} ready`),a>0&&(r+=` ‚Ä¢ ${a} processing`),n.innerHTML=`\n            <span style="color:#1e40af; font-size:13px; font-weight:500;">üìã ${r}</span>\n            <span style="color:#3b82f6; font-size:12px;">View ‚Üí</span>\n        `,t.appendChild(n)}if(e.error){const n=document.createElement("div");n.style.padding="12px",n.style.background="#fee2e2",n.style.color="#b91c1c",n.style.borderRadius="8px",n.style.fontSize="13px",n.textContent=e.error,t.appendChild(n)}const i=document.createElement("div");if(i.style.flex="1",i.style.display="flex",i.style.flexDirection="column",e.uploadedImage){const t=document.createElement("div");t.style.position="relative",t.style.borderRadius="12px",t.style.overflow="hidden",t.style.background="#f1f5f9",t.style.maxHeight="300px",t.style.display="flex",t.style.justifyContent="center";const n=document.createElement("img");n.src=URL.createObjectURL(e.uploadedImage),n.style.maxWidth="100%",n.style.maxHeight="300px",n.style.objectFit="contain";const o=document.createElement("button");o.textContent="Change photo",o.style.position="absolute",o.style.bottom="12px",o.style.right="12px",o.style.padding="6px 12px",o.style.background="rgba(255,255,255,0.9)",o.style.border="1px solid rgba(0,0,0,0.1)",o.style.borderRadius="6px",o.style.fontSize="12px",o.style.cursor="pointer",o.onclick=()=>m.setUploadedImage(null),t.appendChild(n),t.appendChild(o),i.appendChild(t)}else{const e=document.createElement("label");e.className="aif-dropzone",e.innerHTML='\n      <div style="width:40px; height:40px; border-radius:50%; background:#dcfce7; display:flex; align-items:center; justify-content:center; color:#166534; font-size:20px;">\n        ‚¨Ü\n      </div>\n      <div>\n        <span style="font-weight:600; color:#166534;">Upload a room photo</span>\n        <span style="color:#64748b; margin:0 4px;">or drag & drop</span>\n      </div>\n      <p style="font-size:11px; color:#94a3b8; margin:0;">JPG or PNG, up to 10 MB</p>\n    ';const t=document.createElement("input");t.type="file",t.accept="image/*",t.style.display="none",t.onchange=e=>{if(e.target.files[0]){const t=e.target.files[0];m.setUploadedImage(t);const n=g.getState();A("image_uploaded",{productUrl:n.config?.productUrl||window.location.href,productName:n.config?.productTitle||document.title,imageSize:t.size,imageType:t.type,fileName:t.name})}},e.appendChild(t),i.appendChild(e)}t.appendChild(i);const a=document.createElement("div");a.style.marginTop="auto";const r=f({text:"Generate Preview",disabled:!e.uploadedImage,onClick:async()=>{if(!e.uploadedImage)return;r.disabled=!0,r.innerHTML="";const t=document.createElement("div");t.className="aif-spinner";const n=document.createElement("span");n.textContent=" Generating...",r.appendChild(t),r.appendChild(n),r.style.display="flex",r.style.alignItems="center",r.style.justifyContent="center",r.style.gap="8px";try{const t=g.getState(),n=t.config?.productUrl||window.location.href,o=t.config?.productTitle||document.title||n,i=`queue_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,a={id:i,productUrl:n,productName:o,userImage:e.uploadedImage,selectedModel:"slow",config:t.config||{},queuedAt:Date.now()};A("ai_generation_started",{queueId:i,productUrl:n,productName:o,model:"slow",imageSize:e.uploadedImage?.size||0}),m.addToQueue(a),console.log(`‚úÖ Added to queue: ${i}`),m.setView(l.QUEUE),m.setUploadedImage(null),r.disabled=!1,r.innerHTML="",r.textContent="Generate Preview",r.style.display=""}catch(e){console.error("‚ùå Failed to add to queue:",e),m.setError(e.message||"Failed to add to queue"),r.disabled=!1,r.innerHTML="",r.textContent="Generate Preview",r.style.display=""}}});a.appendChild(r);const s=document.createElement("p");return s.textContent="We only use this photo to generate your preview.",s.style.fontSize="10px",s.style.color="#94a3b8",s.style.textAlign="center",s.style.marginTop="8px",a.appendChild(s),t.appendChild(a),t},U=e=>{const t=document.createElement("div");t.style.display="flex",t.style.flexDirection="column",t.style.gap="16px",t.style.height="100%";const n=document.createElement("div");n.innerHTML='\n    <h3 style="margin:0; font-size:16px; font-weight:600;">‚ú® Your room preview</h3>\n    <p style="margin:4px 0 0; font-size:12px; color:#64748b;">Drag the slider to compare.</p>\n  ',t.appendChild(n);const o=document.createElement("div");o.style.display="flex",o.style.flexDirection="column",o.style.gap="16px",o.style.overflowY="auto",o.style.flex="1",o.style.paddingRight="4px",e.generatedImages.forEach(t=>{const n=t.url||t;let i="";t.originalImageUrl?i=t.originalImageUrl:e.uploadedImage&&(i=URL.createObjectURL(e.uploadedImage));const a=t.originalAspectRatio||(t.originalWidth&&t.originalHeight?t.originalWidth/t.originalHeight:null);if(console.log(`üìê Creating slider with aspect ratio: ${a||"auto"}`),n)if(i){const e=(({beforeImage:e,afterImage:t,aspectRatio:n})=>{const o=document.createElement("div"),i=n||"4/3";Object.assign(o.style,{position:"relative",width:"100%",borderRadius:"12px",overflow:"hidden",border:"1px solid #e5e7eb",background:"#f9fafb",aspectRatio:i,userSelect:"none",WebkitUserSelect:"none",touchAction:"none",boxShadow:"0 4px 16px rgba(0, 0, 0, 0.08)"});const a=document.createElement("img");a.src=e,Object.assign(a.style,{position:"absolute",inset:"0",width:"100%",height:"100%",objectFit:"contain",pointerEvents:"none"}),n?console.log(`üìê Image aspect ratio (provided): ${n}`):a.onload=()=>{const e=a.naturalWidth/a.naturalHeight;o.style.aspectRatio=e.toString(),console.log(`üìê Image aspect ratio (calculated): ${e.toFixed(2)} (${a.naturalWidth}x${a.naturalHeight})`)};const r=document.createElement("img");r.src=t,Object.assign(r.style,{position:"absolute",inset:"0",width:"100%",height:"100%",objectFit:"contain",clipPath:"inset(0 50% 0 0)",pointerEvents:"none"});const s=document.createElement("div");s.textContent="BEFORE",Object.assign(s.style,{position:"absolute",top:"16px",right:"16px",background:"rgba(0, 0, 0, 0.7)",backdropFilter:"blur(8px)",color:"white",padding:"6px 12px",borderRadius:"6px",fontSize:"11px",fontWeight:"700",letterSpacing:"0.05em",zIndex:"5",pointerEvents:"none"});const l=document.createElement("div");l.textContent="AFTER",Object.assign(l.style,{position:"absolute",top:"16px",left:"16px",background:"rgba(16, 185, 129, 0.9)",backdropFilter:"blur(8px)",color:"white",padding:"6px 12px",borderRadius:"6px",fontSize:"11px",fontWeight:"700",letterSpacing:"0.05em",zIndex:"5",pointerEvents:"none"});const d=document.createElement("div");Object.assign(d.style,{position:"absolute",top:"0",bottom:"0",left:"50%",transform:"translateX(-50%)",width:"40px",display:"flex",justifyContent:"center",alignItems:"center",cursor:"ew-resize",zIndex:"10"});const c=document.createElement("div");Object.assign(c.style,{width:"3px",height:"100%",background:"linear-gradient(180deg, rgba(255,255,255,0.9), rgba(255,255,255,1), rgba(255,255,255,0.9))",boxShadow:"0 0 10px rgba(0, 0, 0, 0.3), 0 0 20px rgba(0, 0, 0, 0.2)",pointerEvents:"none"});const u=document.createElement("div");Object.assign(u.style,{position:"absolute",top:"50%",left:"50%",transform:"translate(-50%, -50%)",width:"48px",height:"48px",background:"white",borderRadius:"50%",boxShadow:"0 4px 16px rgba(0, 0, 0, 0.2)",display:"flex",alignItems:"center",justifyContent:"center",transition:"transform 0.2s cubic-bezier(0.4, 0, 0.2, 1)",pointerEvents:"none"}),u.innerHTML='\n        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">\n            <polyline points="15 18 9 12 15 6"></polyline>\n        </svg>\n        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" style="margin-left: -8px;">\n            <polyline points="9 18 15 12 9 6"></polyline>\n        </svg>\n    ',d.appendChild(c),d.appendChild(u);let p=!1;const g=e=>{const t=o.getBoundingClientRect();let n=(e-t.left)/t.width*100;return n=Math.max(0,Math.min(100,n)),r.style.clipPath=`inset(0 ${100-n}% 0 0)`,d.style.left=`${n}%`,n},m=e=>{p&&g(e.clientX)},f=()=>{p&&(p=!1,o.style.cursor="",u.style.transform="translate(-50%, -50%) scale(1)",u.style.boxShadow="0 4px 16px rgba(0, 0, 0, 0.2)")},h=e=>{if(!p)return;const t=e.touches[0];g(t.clientX),e.preventDefault()},y=()=>{p&&(p=!1,u.style.transform="translate(-50%, -50%) scale(1)",u.style.boxShadow="0 4px 16px rgba(0, 0, 0, 0.2)")};return d.addEventListener("mouseenter",()=>{p||(u.style.transform="translate(-50%, -50%) scale(1.05)")}),d.addEventListener("mouseleave",()=>{p||(u.style.transform="translate(-50%, -50%) scale(1)")}),d.addEventListener("mousedown",e=>{p=!0,o.style.cursor="ew-resize",u.style.transform="translate(-50%, -50%) scale(1.1)",u.style.boxShadow="0 6px 20px rgba(0, 0, 0, 0.25)",e.preventDefault()}),document.addEventListener("mousemove",m),document.addEventListener("mouseup",f),d.addEventListener("touchstart",e=>{p=!0,u.style.transform="translate(-50%, -50%) scale(1.1)",u.style.boxShadow="0 6px 20px rgba(0, 0, 0, 0.25)"},{passive:!1}),document.addEventListener("touchmove",h,{passive:!1}),document.addEventListener("touchend",y),o._cleanup=()=>{document.removeEventListener("mousemove",m),document.removeEventListener("mouseup",f),document.removeEventListener("touchmove",h),document.removeEventListener("touchend",y)},o.appendChild(a),o.appendChild(r),o.appendChild(s),o.appendChild(l),o.appendChild(d),o})({beforeImage:i,afterImage:n,aspectRatio:a});o.appendChild(e)}else{const e=document.createElement("img");e.src=n,e.style.maxWidth="100%",e.style.borderRadius="8px",o.appendChild(e)}}),t.appendChild(o);const i=document.createElement("div");i.style.display="flex",i.style.flexDirection="column",i.style.gap="8px",i.style.marginTop="auto";const a=f({text:"Close",variant:"secondary",onClick:m.closeModal,className:"aif-btn-secondary"});a.style.background="white",a.style.border="1px solid #cbd5e1",a.style.color="#475569",a.onmouseover=()=>a.style.background="#f8fafc",a.onmouseout=()=>a.style.background="white";const r=document.createElement("button");return r.textContent="Try another photo",r.style.background="none",r.style.border="none",r.style.color="#64748b",r.style.fontSize="12px",r.style.cursor="pointer",r.style.textDecoration="underline",r.onclick=m.reset,i.appendChild(a),i.appendChild(r),t.appendChild(i),t},L=e=>{const t=document.createElement("div");t.style.display="flex",t.style.flexDirection="column",t.style.gap="16px",t.style.height="100%";const n=document.createElement("div");n.className="aif-header";const o=e.queue.filter(e=>e.status===c||e.status===d).length,i=e.queue.filter(e=>e.status===u).length,a=e.queue.filter(e=>e.status===p).length;n.innerHTML=`\n    <div class="aif-badge">\n      <span style="width:6px; height:6px; border-radius:50%; background:${o>0?"#3b82f6":"#22c55e"};"></span>\n      Your Visualizations\n    </div>\n    <h2>Queue & Results</h2>\n    <p>${o} processing ‚Ä¢ ${i} completed ${a>0?`‚Ä¢ ${a} failed`:""}</p>\n  `,t.appendChild(n);const r=e.queueTab||"all",s=document.createElement("div");s.style.display="flex",s.style.gap="8px",s.style.borderBottom="1px solid #e2e8f0",s.style.marginBottom="8px";const g=[{id:"all",label:"All",count:e.queue.length},{id:"processing",label:"Processing",count:o},{id:"completed",label:"Completed",count:i}];a>0&&g.push({id:"failed",label:"Failed",count:a}),g.forEach(e=>{const t=document.createElement("button");t.textContent=`${e.label} (${e.count})`,t.style.padding="8px 16px",t.style.background="none",t.style.border="none",t.style.borderBottom=r===e.id?"2px solid #3b82f6":"2px solid transparent",t.style.color=r===e.id?"#3b82f6":"#64748b",t.style.fontWeight=r===e.id?"600":"400",t.style.cursor="pointer",t.style.fontSize="13px",t.style.transition="all 0.2s",t.onclick=()=>{m.setQueueTab(e.id)},s.appendChild(t)}),t.appendChild(s);let h=e.queue;"processing"===r?h=e.queue.filter(e=>e.status===c||e.status===d):"completed"===r?h=e.queue.filter(e=>e.status===u):"failed"===r&&(h=e.queue.filter(e=>e.status===p));const y=document.createElement("div");y.style.flex="1",y.style.overflowY="auto",y.style.display="flex",y.style.flexDirection="column",y.style.gap="12px",0===h.length?y.innerHTML='<p style="text-align:center; color:#94a3b8; margin-top:20px;">No items in this category.</p>':h.forEach(e=>{const t=function(e){const t=document.createElement("div");t.style.padding="16px",t.style.background="#ffffff",t.style.borderRadius="12px",t.style.border="1px solid #e2e8f0",t.style.display="flex",t.style.gap="12px",t.style.transition="all 0.2s",t.style.boxShadow="0 1px 3px rgba(0,0,0,0.05)";const n=document.createElement("div");if(n.style.width="60px",n.style.height="60px",n.style.borderRadius="8px",n.style.background="#f1f5f9",n.style.flexShrink="0",n.style.display="flex",n.style.alignItems="center",n.style.justifyContent="center",n.style.overflow="hidden",e.userImageUrl){const t=document.createElement("img");t.src=e.userImageUrl,t.style.width="100%",t.style.height="100%",t.style.objectFit="cover",n.appendChild(t)}else n.innerHTML='<span style="font-size:24px;">üñºÔ∏è</span>';t.appendChild(n);const o=document.createElement("div");o.style.flex="1",o.style.display="flex",o.style.flexDirection="column",o.style.gap="4px";const i=document.createElement("div");i.style.fontWeight="600",i.style.fontSize="14px",i.style.color="#1e293b",i.textContent=e.productName||`Product #${e.id.slice(0,8)}`,o.appendChild(i);const a=document.createElement("div");if(a.style.display="flex",a.style.alignItems="center",a.style.gap="6px",a.style.fontSize="12px",a.style.marginTop="4px",e.status===d)a.innerHTML='<span style="color:#64748b;">‚è≥ Waiting in queue...</span>';else if(e.status===c){const t=e.startedAt?Math.floor((Date.now()-e.startedAt)/1e3):0,n=75,o=Math.max(0,n-t);a.innerHTML=`\n            <span style="color:#3b82f6; display:flex; align-items:center; gap:4px;">\n                <span class="spinner" style="width:12px; height:12px; border:2px solid #3b82f6; border-top-color:transparent; border-radius:50%; animation:spin 0.8s linear infinite;"></span>\n                Processing... ${t}s elapsed ‚Ä¢ ~${o}s remaining\n            </span>\n        `}else if(e.status===u){const t=e.result?.generationTime||"N/A";a.innerHTML=`<span style="color:#22c55e;">‚úÖ Completed in ${t}s</span>`}else e.status===p&&(a.innerHTML=`<span style="color:#ef4444;">‚ùå ${e.error||"Failed"}</span>`);o.appendChild(a),t.appendChild(o);const r=document.createElement("div");if(r.style.display="flex",r.style.flexDirection="column",r.style.gap="6px",r.style.alignSelf="center",e.status===u){const t=document.createElement("button");t.textContent="View",t.style.padding="8px 16px",t.style.background="#3b82f6",t.style.color="white",t.style.border="none",t.style.borderRadius="6px",t.style.cursor="pointer",t.style.fontSize="12px",t.style.fontWeight="600",t.onclick=()=>{A("results_viewed",{queueId:e.id,productUrl:e.productUrl,productName:e.productName,model:e.selectedModel,generationTime:e.result?.generationTime});const t={url:e.result?.generatedImageUrl,originalImageUrl:e.result?.originalImageUrl||e.userImageUrl,originalAspectRatio:e.result?.originalAspectRatio,originalWidth:e.result?.originalWidth,originalHeight:e.result?.originalHeight};m.setGenerationResults([t])},r.appendChild(t);const n=document.createElement("button");n.textContent="Delete",n.style.padding="6px 12px",n.style.background="transparent",n.style.color="#64748b",n.style.border="1px solid #e2e8f0",n.style.borderRadius="6px",n.style.cursor="pointer",n.style.fontSize="11px",n.onclick=()=>{m.removeFromQueue(e.id)},r.appendChild(n)}else if(e.status===p){const t=document.createElement("button");t.textContent="Retry",t.style.padding="8px 16px",t.style.background="#f59e0b",t.style.color="white",t.style.border="none",t.style.borderRadius="6px",t.style.cursor="pointer",t.style.fontSize="12px",t.onclick=()=>{m.updateQueueItem(e.id,{status:d,error:null})},r.appendChild(t)}else if(e.status===c||e.status===d){const t=document.createElement("button");t.textContent="Cancel",t.style.padding="6px 12px",t.style.background="transparent",t.style.color="#ef4444",t.style.border="1px solid #fee2e2",t.style.borderRadius="6px",t.style.cursor="pointer",t.style.fontSize="11px",t.onclick=()=>{confirm("Cancel this generation?")&&m.removeFromQueue(e.id)},r.appendChild(t)}return t.appendChild(r),t}(e);y.appendChild(t)}),t.appendChild(y);const b=document.createElement("div");b.style.marginTop="auto",b.style.display="flex",b.style.gap="8px";const w=f({text:"Back to Upload",variant:"secondary",onClick:()=>m.setView(l.UPLOAD)});if(b.appendChild(w),i>0){const e=f({text:"Clear Completed",variant:"secondary",onClick:()=>{confirm("Clear all completed items?")&&m.clearCompleted()}});b.appendChild(e)}return t.appendChild(b),t};if("undefined"!=typeof document){const e=document.createElement("style");e.textContent="\n        @keyframes spin {\n            to { transform: rotate(360deg); }\n        }\n    ",document.head.appendChild(e)}const O=()=>{const e=document.createElement("div");e.id="ai-furniture-modal";const t=document.createElement("div");t.className="aif-container";const n=document.createElement("button");n.className="aif-close-btn",n.innerHTML="√ó",n.onclick=m.closeModal,t.appendChild(n);const o=document.createElement("div");o.className="aif-content",t.appendChild(o),e.appendChild(t),e.addEventListener("click",t=>{t.target===e&&m.closeModal()});return g.subscribe(t=>{t.isOpen?(e.classList.add("open"),document.body.style.overflow="hidden"):(e.classList.remove("open"),document.body.style.overflow=""),(e=>{o.innerHTML="",e.view===l.UPLOAD?o.appendChild(D(e)):e.view===l.GENERATING?o.appendChild(L(e)):e.view===l.RESULTS?o.appendChild(U(e)):e.view===l.QUEUE?o.appendChild(L(e)):e.view===l.ERROR&&o.appendChild(D(e))})(t)}),e};function N(){if(document.getElementById("ai-furniture-trigger-btn"))return;const e=document.createElement("div");e.id="ai-furniture-trigger-btn",e.setAttribute("role","button"),e.setAttribute("tabindex","0");const t=/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)||window.innerWidth<=768||"ontouchstart"in window;Object.assign(e.style,{position:"fixed",bottom:t?"20px":"24px",right:t?"20px":"24px",zIndex:"9999",background:"linear-gradient(135deg, #10b981 0%, #059669 100%)",color:"#ffffff",padding:t?"14px 20px":"14px 24px",borderRadius:"999px",boxShadow:"0 8px 24px rgba(16, 185, 129, 0.35), 0 2px 8px rgba(0, 0, 0, 0.1)",cursor:"pointer",fontFamily:'-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif',fontSize:t?"14px":"15px",fontWeight:"600",display:"flex",alignItems:"center",gap:"10px",transition:"all 0.3s cubic-bezier(0.4, 0, 0.2, 1)",opacity:"0",transform:"translateY(20px) scale(0.9)",pointerEvents:"none",border:"none",backdropFilter:"blur(10px)",WebkitBackdropFilter:"blur(10px)",WebkitUserSelect:"none",userSelect:"none",WebkitTapHighlightColor:"transparent",touchAction:"manipulation",minHeight:"48px",minWidth:"48px",letterSpacing:"0.01em"});const n=document.createElement("span");n.innerHTML="‚ú®",n.style.fontSize="20px",n.style.lineHeight="1",e.appendChild(n);const o=document.createElement("span");o.textContent="Visualize in Your Room",o.style.lineHeight="1",e.appendChild(o);const i=document.createElement("span");if(i.style.display="none",i.style.position="absolute",i.style.top="-6px",i.style.right="-6px",i.style.background="#ef4444",i.style.color="white",i.style.fontSize="11px",i.style.fontWeight="700",i.style.padding="4px 8px",i.style.borderRadius="999px",i.style.minWidth="20px",i.style.textAlign="center",i.style.boxShadow="0 2px 8px rgba(0, 0, 0, 0.2)",i.style.border="2px solid white",e.appendChild(i),t||(e.addEventListener("mouseenter",()=>{e.style.transform="translateY(-4px) scale(1.02)",e.style.boxShadow="0 12px 32px rgba(16, 185, 129, 0.45), 0 4px 12px rgba(0, 0, 0, 0.15)"}),e.addEventListener("mouseleave",()=>{e.style.transform="translateY(0) scale(1)",e.style.boxShadow="0 8px 24px rgba(16, 185, 129, 0.35), 0 2px 8px rgba(0, 0, 0, 0.1)"})),e.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),F()}),t){let t=0;e.addEventListener("touchstart",n=>{t=Date.now(),e.style.transform="scale(0.95)",e.style.opacity="0.9"},{passive:!0}),e.addEventListener("touchend",n=>{n.preventDefault(),n.stopPropagation();const o=Date.now()-t;e.style.transform="scale(1)",e.style.opacity="1",o<300&&F()},{passive:!1})}g.subscribe(t=>{const n=t.queue.filter(e=>e.status===c).length,o=t.queue.filter(e=>e.status===u).length,i=t.queue.length,a=e.querySelector("span:nth-child(2)"),r=e.querySelector("span:last-child");a&&(n>0?(a.textContent=`Generating ${n}...`,r.style.display="block",r.textContent=n,r.style.background="linear-gradient(135deg, #3b82f6, #2563eb)",e.style.background="linear-gradient(135deg, #3b82f6, #2563eb)"):o>0?(a.textContent=`${o} Ready to View`,r.style.display="block",r.textContent=o,r.style.background="linear-gradient(135deg, #22c55e, #16a34a)",e.style.background="linear-gradient(135deg, #22c55e, #16a34a)"):i>0?(a.textContent="View Queue",r.style.display="block",r.textContent=i,r.style.background="linear-gradient(135deg, #64748b, #475569)",e.style.background="linear-gradient(135deg, #64748b, #475569)"):(a.textContent="Visualize in Your Room",r.style.display="none",e.style.background="linear-gradient(135deg, #10b981, #059669)"))}),document.body.appendChild(e),I("Widget button added to body (floating bottom-right)"),setTimeout(()=>{requestAnimationFrame(()=>{e.style.opacity="1",e.style.transform="translateY(0) scale(1)",e.style.pointerEvents="auto"})},100),function(){const e=document.getElementById("ai-furniture-trigger-btn");if(!e)return;const t=/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)||window.innerWidth<=768||"ontouchstart"in window;let n=t?16:20,o=t?16:20;["#intercom-container","#launcher","#drift-widget"].forEach(e=>{document.querySelector(e)&&(n=t?80:100)}),e.style.bottom=`${n}px`,e.style.right=`${o}px`}()}function F(){const e=window.location.href,t=g.getState();A("widget_opened",{productUrl:e,productName:document.title,hasQueueItems:t.queue&&t.queue.length>0,queueCount:t.queue?t.queue.length:0});try{sessionStorage.setItem("ai_furniture_user","true")}catch(e){console.warn("‚ö†Ô∏è Could not save user state to sessionStorage:",e.message)}t.queue&&t.queue.length>0?(m.openModal({productUrl:e}),m.setView(l.QUEUE)):(m.openModal({productUrl:e}),m.setView(l.UPLOAD))}function z(){try{return"aif_widget_init_"+((window.__AIFurnitureConfig||{}).domain||"default")}catch{return"aif_widget_init_default"}}function P(){try{return!!document.getElementById("ai-furniture-trigger-btn")||"true"===sessionStorage.getItem(z())}catch{return!1}}function q(e){try{e?sessionStorage.setItem(z(),"true"):sessionStorage.removeItem(z())}catch(e){console.warn("Failed to update widget init state in sessionStorage",e)}}async function M(e=!1){console.log("üöÄ INITIALIZING WIDGET:",{isInitialLoad:e,currentUrl:window.location.href,currentPage:window.location.pathname+window.location.search,alreadyInitialized:P(),hasConfig:!!window.__AIFurnitureConfig});if(document.getElementById("ai-furniture-trigger-btn")&&!e)return console.log("‚úÖ Widget button already exists, updating page tracking only"),void function(){const e="true"===sessionStorage.getItem("ai_furniture_user");e&&(console.log("üìÑ Updating page tracking for new URL"),A("page_view",{title:document.title,url:window.location.href,isProductPage:E(),aiFurnitureUser:!0}),k())}();I("Initializing AI Furniture widget",{isInitialLoad:e});const t=window.location.hostname,n="aif_domain_verified_"+t.replace(/^www\./,"");let o="true"===sessionStorage.getItem(n);if(o)console.log("‚úÖ Domain already verified with backend database, skipping verification");else{if(!function(){w();const e=window.location.hostname;return"localhost"===e||"127.0.0.1"===e||"0.0.0.0"===e||e.startsWith("192.168.")||e.startsWith("10.0.")||e.startsWith("172.16.")||e.endsWith(".local")?(I("Domain verification skipped for local development",{currentHostname:e}),console.log("üîß AI Furniture Widget: Running in local development mode"),!0):(I("Domain check passed (will verify with backend database)",{currentHostname:e}),!0)}())return;const e=await async function(){const e=w(),t=window.location.hostname;if("localhost"===t||"127.0.0.1"===t||"0.0.0.0"===t||t.startsWith("192.168.")||t.startsWith("10.0.")||t.startsWith("172.16.")||t.endsWith(".local"))return I("Skipping server verification for local development",{currentHostname:t}),!0;try{const n=new AbortController,o=setTimeout(()=>n.abort(),1e4);let i=e.apiEndpoint;if(i||(i="localhost"===window.location.hostname||"127.0.0.1"===window.location.hostname||"0.0.0.0"===window.location.hostname?"http://localhost:3000/api":"https://ai-furniture-backend.vercel.app/api",console.warn("‚ö†Ô∏è apiEndpoint was undefined in domainVerification, using fallback:",i)),!i||"string"!=typeof i)return console.error("‚ùå Invalid API endpoint, cannot verify domain with server"),!1;const a=t.replace(/^www\./,""),r=`${i}/health?domain=${encodeURIComponent(a)}`;console.log("üîç Checking backend database for domain:",a,"(normalized from:",t+")");const s=await fetch(r,{method:"GET",headers:{Accept:"application/json"},signal:n.signal,credentials:"omit",mode:"cors"});if(clearTimeout(o),!s.ok)return await s.text(),console.error('üö´ AI Furniture Widget: Domain "'+t+'" (normalized: "'+a+'") is not authorized. Server returned status '+s.status+". Please ensure this domain (with or without www) is registered in the backend database."),!1;const l=await s.json().catch(()=>({}));return console.log("‚úÖ AI Furniture Widget: Domain verified by backend database:",a,"(from:",t+")"),I("Domain verified by server database",{currentHostname:t,normalizedDomain:a,responseData:l}),!0}catch(e){return"AbortError"===e.name?console.error("‚ùå AI Furniture Widget: Server verification timeout. Cannot verify domain with backend database."):console.error("‚ùå AI Furniture Widget: Could not verify domain with backend database:",e.message),!1}}();if(!e)return void console.error('üö´ AI Furniture Widget: Domain "'+t+'" is not authorized in backend database. Widget will not initialize.');try{sessionStorage.setItem(n,"true"),o=!0}catch(e){console.warn("Failed to save domain verification state",e)}}console.log("init widget"),function(){let e=sessionStorage.getItem("ai_furniture_session_id");e||(e=C(),sessionStorage.setItem("ai_furniture_session_id",e)),x(e),I("Widget script loaded",{domain:w().domain,sessionId:e})}();const i="true"===sessionStorage.getItem("tracking_disconnected"),a=sessionStorage.getItem("order_completed_at");if(i&&a){console.log("üîå Tracking disconnected due to completed order - checking if should re-enable");if(!E())return console.log("‚ùå Non-product page after order completion - keeping tracking disabled"),void I("Non-product page after order completion - keeping tracking disabled");console.log("üîÑ PRODUCT PAGE DETECTED - re-enabling tracking for new session"),I("Product page detected after order completion - re-enabling tracking"),T(),q(!1)}else if(i)return console.log("üîå Tracking already disconnected - skipping widget initialization"),void I("Tracking already disconnected - skipping widget initialization");const r="true"===sessionStorage.getItem("ai_furniture_user");if(r){console.log("üîç CALLING trackOrderConfirmationPage()...");const e=function(){const e=window.location.pathname+window.location.search,t=window.location.href;console.log("üîç CHECKING FOR ORDER CONFIRMATION PAGE:",{currentPage:e,fullUrl:t,pathname:window.location.pathname,search:window.location.search,hash:window.location.hash});const n=[/\/confirmation\?order=[A-Z0-9-]+/i,/\/success\?order=[A-Z0-9-]+/i,/\/thank-you\?order=[A-Z0-9-]+/i,/\/order-confirmation\?order=[A-Z0-9-]+/i,/\/checkout\/success\?order=[A-Z0-9-]+/i,/\/order\/success\?order=[A-Z0-9-]+/i,/\/payment\/success\?order=[A-Z0-9-]+/i];console.log("üîç TESTING ORDER CONFIRMATION PATTERNS:",{patterns:n.map(e=>e.toString()),currentPage:e});const o=n.some(t=>t.test(e));if(console.log("üîç ORDER CONFIRMATION CHECK RESULT:",{isOrderConfirmation:o,currentPage:e}),o){const t=e.match(/[?&]order[=_-]([A-Z0-9-]+)/i),n=t?t[1]:null;if(n)return console.log("üéØ ORDER CONFIRMATION PAGE DETECTED - SENDING TO BACKEND!",{page:e,orderId:n}),console.log("üîì CLEARING TRACKING DISCONNECTED FLAG TO ALLOW ORDER EVENTS"),sessionStorage.removeItem("tracking_disconnected"),sessionStorage.removeItem("order_completed_at"),sessionStorage.removeItem("order_completion_reason"),console.log("üì§ SENDING ORDER CONFIRMATION EVENT TO BACKEND..."),A("order_confirmation_detected",{orderId:n,confirmationPage:e,isOrderConfirmation:!0}),console.log("üì§ SENDING ORDER PAGE VISIT EVENT TO BACKEND..."),A("order_page_visit",{orderId:n,page:e,isOrderConfirmation:!0}),console.log("‚úÖ BOTH ORDER EVENTS SENT TO BACKEND - waiting for backend processing..."),console.log("‚è∞ Delaying tracking disconnection by 10 seconds to allow order processing..."),setTimeout(()=>{console.log("üîå Now disconnecting tracking after order processing delay"),R()},1e4),!0}return!1}();if(console.log("üîç trackOrderConfirmationPage() RESULT:",{orderConfirmed:e,willStopWidget:e}),e)return void console.log("üéØ Order confirmed - stopping widget initialization")}else console.log("‚ùå Skipping order confirmation check - user has not used AI Furniture"),I("Skipping order confirmation check - user has not used AI Furniture");N(),r?(A("page_view",{title:document.title,url:window.location.href,isProductPage:E(),aiFurnitureUser:!0}),k()):I("First time visitor - no tracking until AI Furniture usage"),S=N,window.onOrderAddedToDatabase=_,q(!0),console.log("‚úÖ Widget fully initialized")}function $(){if(window.__AIFurnitureListenersAttached)return console.log("üîÑ Listeners already attached, skipping..."),void("loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>M(!0)):M(!0));window.__AIFurnitureListenersAttached=!0,"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>M(!0)):M(!0);let e=window.location.href;const t=()=>{const t=window.location.href;if(t!==e){const n=e;e=t,console.log("üîÑ URL changed, updating widget...",{from:n,to:t}),setTimeout(()=>M(!1),100)}};if(window.__AIFurnitureMutationObserver||(window.__AIFurnitureMutationObserver=new MutationObserver(()=>{t()}),window.__AIFurnitureMutationObserver.observe(document,{subtree:!0,childList:!0})),!window.__AIFurniturePushStatePatched){window.__AIFurniturePushStatePatched=!0;const e=history.pushState,n=history.replaceState;history.pushState=function(...n){e.apply(history,n),setTimeout(t,0)},history.replaceState=function(...e){n.apply(history,e),setTimeout(t,0)}}window.__AIFurniturePopstateHandler||(window.__AIFurniturePopstateHandler=t,window.addEventListener("popstate",window.__AIFurniturePopstateHandler)),I("AI Furniture widget initialized successfully")}const W=new Set;let G=!1;const H=e=>{if(!e)return null;try{const t=e.split(","),n=t[0].match(/:(.*?);/)[1],o=atob(t[1]);let i=o.length;const a=new Uint8Array(i);for(;i--;)a[i]=o.charCodeAt(i);return new Blob([a],{type:n})}catch(e){return console.warn("Failed to convert data URL to blob",e),null}};function B(e){const t=e.queue.filter(e=>e.status===d&&!W.has(e.id));t.length>0&&(console.log(`üîÑ Found ${t.length} pending items, processing...`),t.forEach(e=>{Q(e)}))}function j(e){const t=e.queue.filter(e=>e.status===d&&!W.has(e.id));t.length>0&&(console.log(`üîÑ Found ${t.length} pending items...`),t.forEach(e=>{if(e.userImage||e.userImageDataUrl){if(e.userImageDataUrl&&!e.userImage){const t=H(e.userImageDataUrl);if(!t)return console.warn(`‚ö†Ô∏è Failed to restore image from data URL for item ${e.id.slice(0,8)}`),void m.updateQueueItem(e.id,{status:p,completedAt:Date.now(),error:"Failed to restore image data - please re-upload"});e.userImage=t,console.log(`üîÑ Restored image from data URL for item ${e.id.slice(0,8)}`)}console.log(`üöÄ Resuming item ${e.id.slice(0,8)}...`),Q(e)}else console.warn(`‚ö†Ô∏è Item ${e.id.slice(0,8)} lost image data (page reload), marking as error`),m.updateQueueItem(e.id,{status:p,completedAt:Date.now(),error:"Image data lost after page reload - please add to queue again"})}));const n=e.queue.filter(e=>e.status===c&&!W.has(e.id));n.length>0&&(console.log(`üîÑ Found ${n.length} processing items from previous page, resetting to PENDING to resume...`),n.forEach(e=>{const t=e.startedAt?Date.now()-e.startedAt:0;if(t>3e5)console.warn(`‚ö†Ô∏è Item ${e.id.slice(0,8)} has been processing for too long (${Math.floor(t/1e3)}s), marking as error`),m.updateQueueItem(e.id,{status:p,completedAt:Date.now(),error:"Generation timed out - please retry"});else{let t=!1;if(!e.userImage&&e.userImageDataUrl){const n=H(e.userImageDataUrl);n&&(e.userImage=n,t=!0,console.log(`üîÑ Restored image from data URL for item ${e.id.slice(0,8)}`))}console.log(`üîÑ Resetting item ${e.id.slice(0,8)} to PENDING to resume processing`);const n={status:d,startedAt:null};t&&(n.userImage=e.userImage),m.updateQueueItem(e.id,n)}}))}async function Q(e){const{id:t,userImage:n,productUrl:o,selectedModel:i,config:a,userImageDataUrl:r}=e;if(W.has(t))return void console.log(`‚è≠Ô∏è Item ${t.slice(0,8)} already being processed, skipping...`);let s=n;if(!s||!(s instanceof File||s instanceof Blob)){if(!r)return console.error(`‚ùå Item ${t.slice(0,8)} has invalid userImage (lost after page reload), marking as error`),void m.updateQueueItem(t,{status:p,completedAt:Date.now(),error:"Image data lost - please re-upload and try again"});{const e=H(r);if(!e)return console.error(`‚ùå Item ${t.slice(0,8)} has invalid userImage and failed to restore from data URL, marking as error`),void m.updateQueueItem(t,{status:p,completedAt:Date.now(),error:"Image data lost - please re-upload and try again"});s=e,m.updateQueueItem(t,{userImage:e}),console.log(`üîÑ Restored image from data URL for processing ${t.slice(0,8)}`)}}try{W.add(t),m.updateQueueItem(t,{status:c,startedAt:Date.now()});let n=a?.apiEndpoint;if(!n){n="undefined"!=typeof window&&("localhost"===window.location.hostname||"127.0.0.1"===window.location.hostname||"0.0.0.0"===window.location.hostname)?"http://localhost:3000/api":"https://ai-furniture-backend.vercel.app/api"}console.log(`üöÄ Starting generation for ${t.slice(0,8)} with ${i} model`);const r=new FormData;r.append("image",s),r.append("productUrl",o),r.append("model","slow"),r.append("domain",a?.domain||window.location.hostname),a?.sessionId&&r.append("sessionId",a.sessionId);const l=await fetch(`${n}/generate`,{method:"POST",headers:{Accept:"application/json"},body:r,credentials:"omit"});if(!l.ok){const e=await l.json();throw new Error(e.error||"Failed to generate images")}const d=await l.json();console.log(`‚úÖ Generation complete for ${t.slice(0,8)}:`,d);const p=d.generatedImages?.[0]?.originalImageUrl,g=d.generatedImages?.[0]?.url;m.updateQueueItem(t,{status:u,completedAt:Date.now(),userImageUrl:p||e.userImageUrl,result:{generatedImageUrl:g,originalImageUrl:p,model:i,generationTime:d.timings?.total?.durationSeconds,timestamp:(new Date).toISOString(),productData:d.productData,originalAspectRatio:d.originalImageDimensions?.aspectRatio||d.generatedImages?.[0]?.originalAspectRatio,originalWidth:d.originalImageDimensions?.width||d.generatedImages?.[0]?.originalWidth,originalHeight:d.originalImageDimensions?.height||d.generatedImages?.[0]?.originalHeight}}),A("ai_generation_completed",{queueId:t,productUrl:o,productName:e.productName||document.title,model:i,generationTime:d.timings?.total?.durationSeconds,hasResult:!!g,generatedImageUrl:g}),W.delete(t)}catch(e){console.error(`‚ùå Generation failed for ${t.slice(0,8)}:`,e),m.updateQueueItem(t,{status:p,completedAt:Date.now(),error:e.message||"Generation failed"}),W.delete(t)}}return"undefined"!=typeof window&&window.addEventListener("beforeunload",()=>{W.clear()}),e.initAIFurnitureWidget=function(e={}){if("undefined"==typeof window||"undefined"==typeof document)return;!e.domain&&window.FURNITURE_AI_CONFIG&&(console.log("üì¶ Using config from window.FURNITURE_AI_CONFIG"),e={...window.FURNITURE_AI_CONFIG,...e});const t=function(e={}){let t={...i};return!0===e.useLocalBackend?(t.apiEndpoint="http://localhost:3000/api",t.trackingEndpoint="http://localhost:3000/api/tracking/pixel",t.widgetEndpoint="http://localhost:3000/furniture",t.debug=!0):!1===e.useLocalBackend&&(t.apiEndpoint="https://ai-furniture-backend.vercel.app/api",t.trackingEndpoint="https://ai-furniture-backend.vercel.app/api/tracking/pixel",t.widgetEndpoint="https://ai-furniture-backend.vercel.app/furniture"),{...t,...e}}(e);if(b(t),window.__AIFurnitureConfig=t,window.__AIFurnitureInitialized)return console.log("AI Furniture Widget already initialized in this script execution, skipping..."),window.AIFurniture||(window.AIFurniture={open:e=>m.openModal(e),close:m.closeModal,getState:()=>g.getState()}),void $();window.__AIFurnitureInitialized=!0,(()=>{if("undefined"==typeof document)return;if(document.getElementById("ai-furniture-styles"))return;const e=document.createElement("style");e.id="ai-furniture-styles",e.textContent="\n  :root {\n    --aif-primary: #10b981;\n    --aif-primary-hover: #059669;\n    --aif-primary-dark: #047857;\n    --aif-bg-overlay: rgba(0, 0, 0, 0.6);\n    --aif-bg-panel: #ffffff;\n    --aif-text-main: #111827;\n    --aif-text-muted: #6b7280;\n    --aif-border: #e5e7eb;\n    --aif-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);\n    --aif-radius: 20px;\n    --aif-radius-sm: 12px;\n    --aif-font: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;\n  }\n\n  #ai-furniture-modal {\n    position: fixed;\n    inset: 0;\n    width: 100%;\n    height: 100%;\n    background: var(--aif-bg-overlay);\n    backdrop-filter: blur(8px);\n    -webkit-backdrop-filter: blur(8px);\n    z-index: 999999;\n    opacity: 0;\n    transition: opacity 0.3s cubic-bezier(0.4, 0, 0.2, 1);\n    font-family: var(--aif-font);\n    display: none;\n  }\n\n  #ai-furniture-modal.open {\n    display: block;\n    opacity: 1;\n  }\n\n  .aif-container {\n    position: fixed;\n    background: var(--aif-bg-panel);\n    box-shadow: var(--aif-shadow);\n    overflow: hidden;\n    transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);\n    display: flex;\n    flex-direction: column;\n  }\n\n  /* Desktop Styles */\n  @media (min-width: 769px) {\n    .aif-container {\n      top: 0;\n      right: 0;\n      height: 100%;\n      width: clamp(360px, 34vw, 520px);\n      border-radius: var(--aif-radius) 0 0 var(--aif-radius);\n      border-left: 1px solid var(--aif-border);\n      transform: translateX(100%);\n    }\n    \n    #ai-furniture-modal.open .aif-container {\n      transform: translateX(0);\n    }\n  }\n\n  /* Mobile Styles */\n  @media (max-width: 768px) {\n    .aif-container {\n      inset: 0;\n      width: 100%;\n      height: 100%;\n      border-radius: 0;\n      transform: translateY(100%);\n    }\n\n    #ai-furniture-modal.open .aif-container {\n      transform: translateY(0);\n    }\n  }\n\n  .aif-close-btn {\n    position: absolute;\n    top: 20px;\n    right: 20px;\n    width: 40px;\n    height: 40px;\n    background: #f9fafb;\n    color: #6b7280;\n    border: none;\n    border-radius: 50%;\n    font-size: 24px;\n    font-weight: 300;\n    cursor: pointer;\n    z-index: 10;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);\n    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);\n  }\n\n  .aif-close-btn:hover {\n    background: #111827;\n    color: white;\n    transform: scale(1.05);\n    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);\n  }\n\n  .aif-close-btn:active {\n    transform: scale(0.95);\n  }\n\n  .aif-content {\n    flex: 1;\n    display: flex;\n    flex-direction: column;\n    padding: 32px 24px 24px;\n    gap: 24px;\n    overflow-y: auto;\n    overflow-x: hidden;\n  }\n\n  .aif-content::-webkit-scrollbar {\n    width: 6px;\n  }\n\n  .aif-content::-webkit-scrollbar-track {\n    background: transparent;\n  }\n\n  .aif-content::-webkit-scrollbar-thumb {\n    background: #e5e7eb;\n    border-radius: 10px;\n  }\n\n  .aif-content::-webkit-scrollbar-thumb:hover {\n    background: #d1d5db;\n  }\n\n  .aif-header {\n    padding-top: 8px;\n  }\n\n  .aif-header h2 {\n    font-size: 24px;\n    font-weight: 700;\n    margin: 0 0 8px 0;\n    color: var(--aif-text-main);\n    letter-spacing: -0.02em;\n  }\n\n  .aif-header p {\n    font-size: 14px;\n    color: var(--aif-text-muted);\n    margin: 0;\n    line-height: 1.6;\n  }\n\n  .aif-badge {\n    display: inline-flex;\n    align-items: center;\n    gap: 6px;\n    padding: 6px 12px;\n    border-radius: 999px;\n    background: linear-gradient(135deg, #d1fae5, #a7f3d0);\n    color: #047857;\n    font-size: 12px;\n    font-weight: 600;\n    text-transform: uppercase;\n    letter-spacing: 0.03em;\n    margin-bottom: 12px;\n    box-shadow: 0 2px 8px rgba(16, 185, 129, 0.15);\n  }\n\n  .aif-dropzone {\n    border: 2px dashed #d1d5db;\n    border-radius: var(--aif-radius-sm);\n    padding: 48px 24px;\n    background: linear-gradient(135deg, #f9fafb 0%, #ffffff 100%);\n    display: flex;\n    flex-direction: column;\n    align-items: center;\n    justify-content: center;\n    gap: 16px;\n    cursor: pointer;\n    text-align: center;\n    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);\n    position: relative;\n    overflow: hidden;\n  }\n\n  .aif-dropzone::before {\n    content: '';\n    position: absolute;\n    inset: 0;\n    background: linear-gradient(135deg, rgba(16, 185, 129, 0.05), rgba(5, 150, 105, 0.05));\n    opacity: 0;\n    transition: opacity 0.3s ease;\n  }\n\n  .aif-dropzone:hover {\n    background: linear-gradient(135deg, #ffffff 0%, #f9fafb 100%);\n    border-color: var(--aif-primary);\n    transform: translateY(-2px);\n    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);\n  }\n\n  .aif-dropzone:hover::before {\n    opacity: 1;\n  }\n\n  .aif-dropzone:active {\n    transform: translateY(0);\n  }\n\n  .aif-btn-primary {\n    width: 100%;\n    border: none;\n    border-radius: var(--aif-radius-sm);\n    padding: 16px 24px;\n    font-size: 15px;\n    font-weight: 600;\n    cursor: pointer;\n    background: linear-gradient(135deg, var(--aif-primary), var(--aif-primary-hover));\n    color: white;\n    box-shadow: 0 4px 16px rgba(16, 185, 129, 0.3);\n    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);\n    letter-spacing: 0.01em;\n  }\n\n  .aif-btn-primary:disabled {\n    background: linear-gradient(135deg, #e5e7eb, #d1d5db);\n    color: #9ca3af;\n    cursor: not-allowed;\n    box-shadow: none;\n    opacity: 0.6;\n  }\n\n  .aif-btn-primary:not(:disabled):hover {\n    transform: translateY(-2px);\n    box-shadow: 0 8px 24px rgba(16, 185, 129, 0.4);\n    background: linear-gradient(135deg, var(--aif-primary-hover), var(--aif-primary-dark));\n  }\n\n  .aif-btn-primary:not(:disabled):active {\n    transform: translateY(0);\n    box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);\n  }\n\n  /* Spinner */\n  .aif-spinner {\n    width: 20px;\n    height: 20px;\n    border: 2.5px solid rgba(255, 255, 255, 0.2);\n    border-radius: 50%;\n    border-top-color: white;\n    animation: aif-spin 0.7s linear infinite;\n  }\n\n  @keyframes aif-spin {\n    to { transform: rotate(360deg); }\n  }\n\n  /* Card */\n  .aif-card {\n    background: #ffffff;\n    border: 1px solid var(--aif-border);\n    border-radius: var(--aif-radius-sm);\n    padding: 16px;\n    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);\n  }\n\n  .aif-card:hover {\n    border-color: #d1d5db;\n    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.06);\n  }\n\n  /* Banner */\n  .aif-banner {\n    padding: 14px 16px;\n    border-radius: var(--aif-radius-sm);\n    font-size: 13px;\n    font-weight: 500;\n    display: flex;\n    align-items: center;\n    gap: 8px;\n    transition: all 0.2s ease;\n  }\n\n  .aif-banner-info {\n    background: linear-gradient(135deg, #eff6ff, #dbeafe);\n    color: #1e40af;\n    border: 1px solid #93c5fd;\n  }\n\n  .aif-banner-success {\n    background: linear-gradient(135deg, #d1fae5, #a7f3d0);\n    color: #065f46;\n    border: 1px solid #6ee7b7;\n  }\n\n  .aif-banner-error {\n    background: linear-gradient(135deg, #fee2e2, #fecaca);\n    color: #991b1b;\n    border: 1px solid #fca5a5;\n  }\n\n  .aif-banner-warning {\n    background: linear-gradient(135deg, #fef3c7, #fde68a);\n    color: #92400e;\n    border: 1px solid #fcd34d;\n  }\n\n  /* Image Preview */\n  .aif-image-preview {\n    position: relative;\n    border-radius: var(--aif-radius-sm);\n    overflow: hidden;\n    background: #f9fafb;\n    border: 1px solid var(--aif-border);\n  }\n\n  .aif-image-preview img {\n    width: 100%;\n    height: auto;\n    display: block;\n  }\n\n  .aif-image-overlay {\n    position: absolute;\n    inset: 0;\n    background: linear-gradient(180deg, transparent 0%, rgba(0, 0, 0, 0.6) 100%);\n    display: flex;\n    align-items: flex-end;\n    padding: 16px;\n    opacity: 0;\n    transition: opacity 0.2s ease;\n  }\n\n  .aif-image-preview:hover .aif-image-overlay {\n    opacity: 1;\n  }\n\n  /* Secondary Button */\n  .aif-btn-secondary {\n    width: 100%;\n    border: 2px solid var(--aif-border);\n    background: white;\n    border-radius: var(--aif-radius-sm);\n    padding: 14px 24px;\n    font-size: 15px;\n    font-weight: 600;\n    color: var(--aif-text-main);\n    cursor: pointer;\n    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);\n  }\n\n  .aif-btn-secondary:hover {\n    background: #f9fafb;\n    border-color: #9ca3af;\n    transform: translateY(-1px);\n  }\n\n  .aif-btn-secondary:active {\n    transform: translateY(0);\n  }\n\n  /* Text Button */\n  .aif-btn-text {\n    background: none;\n    border: none;\n    color: var(--aif-primary);\n    font-size: 14px;\n    font-weight: 600;\n    cursor: pointer;\n    padding: 8px 12px;\n    border-radius: 8px;\n    transition: all 0.2s ease;\n  }\n\n  .aif-btn-text:hover {\n    background: rgba(16, 185, 129, 0.1);\n    color: var(--aif-primary-hover);\n  }\n\n  /* Progress Bar */\n  .aif-progress {\n    width: 100%;\n    height: 6px;\n    background: #e5e7eb;\n    border-radius: 999px;\n    overflow: hidden;\n  }\n\n  .aif-progress-bar {\n    height: 100%;\n    background: linear-gradient(90deg, var(--aif-primary), var(--aif-primary-hover));\n    border-radius: 999px;\n    transition: width 0.3s ease;\n    box-shadow: 0 0 10px rgba(16, 185, 129, 0.5);\n  }\n\n  /* Divider */\n  .aif-divider {\n    height: 1px;\n    background: linear-gradient(90deg, transparent, var(--aif-border), transparent);\n    margin: 16px 0;\n  }\n\n  /* Label */\n  .aif-label {\n    font-size: 13px;\n    font-weight: 600;\n    color: var(--aif-text-main);\n    margin-bottom: 8px;\n    display: block;\n  }\n\n  /* Helper Text */\n  .aif-helper-text {\n    font-size: 12px;\n    color: var(--aif-text-muted);\n    line-height: 1.5;\n  }\n\n  /* Fade In Animation */\n  @keyframes aif-fade-in {\n    from {\n      opacity: 0;\n      transform: translateY(10px);\n    }\n    to {\n      opacity: 1;\n      transform: translateY(0);\n    }\n  }\n\n  .aif-fade-in {\n    animation: aif-fade-in 0.3s ease;\n  }\n\n  /* Pulse Animation */\n  @keyframes aif-pulse {\n    0%, 100% {\n      opacity: 1;\n    }\n    50% {\n      opacity: 0.5;\n    }\n  }\n\n  .aif-pulse {\n    animation: aif-pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;\n  }\n\n  /* Mobile Optimizations */\n  @media (max-width: 768px) {\n    .aif-content {\n      padding: 24px 20px 20px;\n    }\n\n    .aif-header h2 {\n      font-size: 22px;\n    }\n\n    .aif-btn-primary,\n    .aif-btn-secondary {\n      padding: 14px 20px;\n      font-size: 14px;\n    }\n\n    .aif-dropzone {\n      padding: 40px 20px;\n    }\n  }\n",document.head.appendChild(e)})();let n=document.getElementById("ai-furniture-modal");n||(n=O(),document.body.appendChild(n)),function(){if(G){console.log("üîÑ Queue Processor already initialized, skipping...");const e=g.getState();return void(e.queue&&e.queue.length>0&&(console.log("üîÑ Checking queue after script reload..."),j(e)))}G=!0,g.subscribe(e=>{B(e)});const e=g.getState();console.log("üîÑ Queue Processor initialized. Checking for pending items...",{queueLength:e.queue.length,pending:e.queue.filter(e=>e.status===d).length,processing:e.queue.filter(e=>e.status===c).length}),B(e),j(e)}(),window.AIFurniture={open:e=>m.openModal(e),close:m.closeModal,getState:()=>g.getState()},document.querySelectorAll("[data-ai-furniture-trigger]").forEach(e=>{e.addEventListener("click",e=>{e.preventDefault(),m.openModal()})});const o=g.getState();o.isOpen&&console.log("üîÑ Restoring modal state:",{isOpen:o.isOpen,view:o.view}),$(),window.addEventListener("popstate",()=>{g.getState().isOpen&&m.openModal()}),console.log("AI Furniture Widget Initialized üöÄ")},e}({});
